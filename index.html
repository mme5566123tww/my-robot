const msgContainer = document.getElementById('messages');
const actionBar = document.getElementById('action-bar');

// --- æ–°å¢éŸ³æ•ˆå®£å‘Š ---
const btnSound = new Audio('./button sound effect.mp3'); // é»æ“ŠéŸ³æ•ˆ
const fireworkSound = new Audio('./celebrate.mp3');     // ç…™ç«éŸ³æ•ˆ

// æ–°å¢è¨Šæ¯
function sendMsg(text) {
    const div = document.createElement('div');
    div.className = 'msg bot';
    div.innerText = text;
    msgContainer.appendChild(div);
    msgContainer.scrollTop = msgContainer.scrollHeight;
}

// åˆå§‹ç‹€æ…‹
function startSequence() {
    msgContainer.innerHTML = '';
    actionBar.innerHTML = '';
    
    setTimeout(() => {
        sendMsg("ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„è²¼å¿ƒæ©Ÿå™¨äººã€‚");
        setTimeout(() => {
            sendMsg("é€™é‚Šä¸»äººæœ‰æº–å‚™ä¸€å€‹å°ç¦®ç‰©ï¼Œè«‹æ‚¨æ‰“é–‹æ¥æ”¶ ğŸ");
            
            // é¡¯ç¤ºæŒ‰éˆ•
            const btn = document.createElement('button');
            btn.innerText = "æ‰“é–‹æ¥æ”¶";
            btn.onclick = function() {
                btnSound.play(); // ã€æ’­æ”¾é»æ“ŠéŸ³æ•ˆã€‘
                receiveGift();
            };
            actionBar.appendChild(btn);
        }, 1000);
    }, 800);
}

// æ¥æ”¶ç¦®ç‰©å¾Œçš„å›è¦†
function receiveGift() {
    actionBar.innerHTML = ''; 
    
    setTimeout(() => {
        sendMsg("ä½ å°±æ˜¯ä¸»äººèªªçš„é‚£å€‹å¤©å¤©æ™šä¸Š EMO é»‘ç™½äº‚å“­çš„å¥³ç”Ÿå°ä¸å°ï¼Ÿ");
        
        setTimeout(() => {
            sendMsg("ç¾åœ¨çµ¦æˆ‘ç¬‘ï¼ä¸è¦ EMO ä¸è¦å“­ï¼æ‡‚å—ï¼Ÿå¥³äººï¼ğŸ˜");
            
            fireworkSound.play(); // ã€é–‹å§‹æ’­æ”¾ç…™ç«éŸ³æ•ˆã€‘
            triggerFireworks();
        }, 1500);
    }, 800);
}

// ç…™ç«å‹•ç•« (æŒçºŒ5ç§’)
function triggerFireworks() {
    const end = Date.now() + (5 * 1000);

    (function frame() {
        confetti({
            particleCount: 3,
            angle: 60,
            spread: 55,
            origin: { x: 0, y: 0.6 }
        });
        confetti({
            particleCount: 3,
            angle: 120,
            spread: 55,
            origin: { x: 1, y: 0.6 }
        });

        if (Date.now() < end) {
            requestAnimationFrame(frame);
        } else {
            fireworkSound.pause(); // ç…™ç«çµæŸå¾Œåœæ­¢è²éŸ³
            fireworkSound.currentTime = 0; // é‡ç½®è²éŸ³é€²åº¦
            finishConversation();
        }
    }());
}

function finishConversation() {
    setTimeout(() => {
        sendMsg("ç…™ç«çœ‹å®Œäº†ï¼Œä½ å¯ä»¥ç¡è¦ºäº†ã€‚ğŸ’¤");
        
        setTimeout(() => {
            const resetBtn = document.createElement('button');
            resetBtn.innerText = "å†çœ‹ä¸€æ¬¡";
            resetBtn.onclick = function() {
                btnSound.play(); // ã€é»æ“Šæ™‚æ’­æ”¾éŸ³æ•ˆã€‘
                startSequence();
            };
            actionBar.appendChild(resetBtn);
        }, 1000);
    }, 500);
}

window.onload = startSequence;
